<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link rel="SHORTCUT ICON" href="http://www.baidu.com/favicon.ico">
    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="bootstrap3/css/bootstrap.min.css">
    <!-- 可选的Bootstrap主题文件（一般不用引入） -->
    <link rel="stylesheet" href="bootstrap3/css/bootstrap-theme.min.css">
    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="js/jquery.js"></script>
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="bootstrap3/js/bootstrap.min.js"></script>
    <link  rel="stylesheet" type="text/css" href="less/ps.less">
    <script src="$bootstrap/assets/js/jquery-ui-1.10.0.custom.min.js" type="text/javascript"></script>
    <link type="text/css" href="$bootstrap/css/custom-theme/jquery-ui-1.10.0.custom.css" rel="stylesheet"/>
</head>
<body>
<div>
    <h2>将图片拖入下方框内</h2>
    <div class="img-rounded" id="resizer"></div>
</div>
<div id="option" title="Option">
    <select id="default_effect" class="form-control">
        <option>Vertical 10</option>
        <option>Vertical 01</option>
        <option>Horizontal 10</option>
        <option>Horizontal 01</option>
        <option>Vertical 101</option>
        <option>Vertical 010</option>
        <option>Horizontal 101</option>
        <option>Horizontal 010</option>
        <option>Custom</option>
    </select>
    <button id="convert" class="btn btn-primary">Convert</button>
</div>
<a id="frontboard" title="Result" target="_blank"></a>
<img id="backboard">
<script>
    $('#resizer').on('dragenter', function (e) {
        e.originalEvent.dataTransfer.effectAllowed = 'copy';
        e.preventDefault();
        return false;
    }).on('dragover', function (e) {
        e.preventDefault();
        return false;
    }).on('drop', function (e) {
        var file = e.originalEvent.dataTransfer.files[0];
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
            var img = $('#backboard').attr('src', e.target.result).one('load', function () {
                $('#resizer').css({'backgroundImage': 'url(' + e.target.result + ')', width: img.width(), height: img.height()});
            });
        };
        e.preventDefault();
        return false;
    });
    var option = $('#option').dialog({
        autoOpen: true,
        dialogClass: "no-close",
        width: 600,
        position: {at: "right center"}
    });
    var board = $('#frontboard').dialog({
        width: 600,
        autoOpen: false,
        dialogClass: 'mask',
        position: {at: 'center center'}
    });
    $('#convert').click(function (event) {
        var key = $('#default_effect').val().toLowerCase();
        var config = map.render(map[key], map[key.split(' ')[1]]);
        board.dialog('option', 'height', config.height + 30);
        board.dialog('option', 'width', config.width + 20);
        board.dialog('open');
        event.preventDefault();
    });

    var map = {
        'rc': function (i, width) {
            i = i + 1;
            i = i / 4;
            var row = Math.ceil(i / width);
            var column = i - row * width;
            if (column === 0) {
                column = width;
            }
            return {row: row, column: column};
        },
        'row': function (i, width) {
            i = i + 1;
            i = i / 4;
            i = i / width;
            return Math.ceil(i);
        },
        'column': function (i, width) {
            i = i + 1;
            i = i / 4;
            i = i % width;
            return i;
        },
        render: function (logic, scope) {
            var resizer = $('#resizer');
            var config = {
                width: resizer.width(),
                height: resizer.height()
            }
            var canvas = '<canvas width="{{width}}px;" height="{{height}}px;"></canvas>';
            canvas = canvas.replace(/\{\{(.*?)\}\}/g, function ($0, $1) {
                return config[$1];
            });
            canvas = $(canvas);
            canvas.width(config.width);
            canvas.height(config.height);
            canvas.appendTo($('#frontboard').html(''));
            var img = $('#backboard');
            var context = canvas[0].getContext('2d');
            context.drawImage(img[0], 0, 0, config.width, config.height);
            var imageData = context.getImageData(0, 0, config.width, config.height);
            //logic.call(scope, imageData, config);
            var data = imageData.data;
            for (var i = 3; i < data.length; i+= 4) {
                data[i] = opacity(map.rc(i, config.width), config);
            }
            context.putImageData(imageData, 0, 0);
            $('#frontboard').attr('href', canvas[0].toDataURL("image/png"));
            return config;
        },
        'custom': function (imageData, config) {
            var multiplier;
            var data = imageData.data;
            for (var i = 3; i < data.length; i += 4) {
                multiplier = data[i];
                data[i] = this.opacity(map.row(i, config.width), config.height, multiplier);
            }
        },
        'vertical 10': function (imageData, config) {
            var multiplier;
            var data = imageData.data;
            for (var i = 3; i < data.length; i += 4) {
                multiplier = data[i];
                data[i] = this.opacity(map.row(i, config.width), config.height, multiplier);
            }
        },
        'horizontal 10': function (imageData, config) {
            var multiplier;
            var data = imageData.data;
            for (var i = 3; i < data.length; i += 4) {
                multiplier = data[i];
                data[i] = this.opacity(map.column(i, config.width), config.width, multiplier);
            }
        },
        'vertical 101': function (imageData, config) {
            var multiplier;
            var data = imageData.data;
            for (var i = 3; i < data.length; i += 4) {
                multiplier = data[i];
                data[i] = this.opacity(map.row(i, config.width), config.height, multiplier);
            }
        },
        'horizontal 101': function (imageData, config) {
            var multiplier;
            var data = imageData.data;
            for (var i = 3; i < data.length; i += 4) {
                multiplier = data[i];
                data[i] = this.opacity(map.column(i, config.width), config.width, multiplier);
            }
        },
        '01': {
            opacity: function opacity(molecular, denominator, multiplier) {
                return Math.ceil(multiplier * (denominator - molecular) / denominator);
            }
        },
        '10': {
            opacity: function opacity(molecular, denominator, multiplier) {
                return Math.ceil(multiplier * molecular / denominator);
            }
        },
        '010': {
            opacity: function opacity(molecular, denominator, multiplier) {
                var half = Math.ceil(denominator / 2);
                if (molecular < half) {
                    return Math.ceil(multiplier * molecular * 2 / denominator);
                }
                else {
                    return Math.ceil(multiplier * 2 * (1 -  molecular / denominator));
                }
            }
        },
        '101': {
            opacity: function opacity(molecular, denominator, multiplier) {
                var half = Math.ceil(denominator / 2);
                if (molecular > half) {
                    return Math.ceil(multiplier * ( 2 * molecular / denominator - 1 ));
                }
                else {
                    return Math.ceil(multiplier * (1 - 2 * molecular / denominator));
                }
            }
        }
    };
    map['vertical 01'] = map['vertical 10'];
    map['horizontal 01'] = map['horizontal 10'];
    map['vertical 010'] = map['vertical 101'];
    map['horizontal 010'] = map['horizontal 101'];
</script>
</body>
</html>